# 自定义网络配置
networks:
  static-mirrors-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
    name: static-mirrors-network

# 数据卷配置
volumes:
  backend-stats:
    name: static-mirrors-backend-stats

# 服务配置
services:
  # 组合服务（包含后端和前端）
  app:
    image: ghcr.io/scfcn/static-mirrors:latest
    container_name: static-mirrors-app
    ports:
      - "1108:1108"
    networks:
      - static-mirrors-network
    volumes:
      - backend-stats:/app/data
      - ./config:/config:ro
    environment:
      - GIN_MODE=release
      - TZ=Asia/Shanghai
      - STATS_DB_PATH=/app/data/stats.db
      - CACHE_TYPE=memory
      - CACHE_TTL=${CACHE_TTL:-3600}
    restart: no
    entrypoint: ["/bin/sh", "-c", "ls -la / && ls -la /config && ls -la /app && find /app -name 'main' -type f && cat /app/main 2>/dev/null || echo 'No main file found' && sleep 3600"]
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: "512M"
        reservations:
          cpus: "0.5"
          memory: "256M"