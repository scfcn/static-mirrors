# 自定义网络配置
networks:
  static-mirrors-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
    name: static-mirrors-network

# 数据卷配置
volumes:
  redis-data:
    name: static-mirrors-redis-data
  backend-stats:
    name: static-mirrors-backend-stats

# 服务配置
services:
  # 组合服务（包含后端和前端）
  app:
    image: ghcr.io/scfcn/static-mirrors:latest
    container_name: static-mirrors-app
    ports:
      - "1108:1108"
    networks:
      - static-mirrors-network
    volumes:
      - backend-stats:/app/data
      - ./config:/config:ro
    environment:
      - GIN_MODE=release
      - TZ=Asia/Shanghai
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-''}
      - REDIS_DB=0
      - STATS_DB_PATH=/app/data/stats.db
      - CACHE_TYPE=${CACHE_TYPE:-redis}
      - CACHE_TTL=${CACHE_TTL:-3600}
    depends_on:
      - redis
    restart: no
    entrypoint: ["/bin/sh", "-c", "ls -la / && ls -la /config && ls -la /app && if [ ! -f /config/config.yaml ]; then echo 'Config file not found, downloading...' && mkdir -p /config && wget -O /config/config.yaml https://raw.githubusercontent.com/scfcn/static-mirrors/refs/heads/main/config/config.yaml || echo 'Failed to download config file'; fi && if [ -f /app/static-mirrors ]; then chmod +x /app/static-mirrors && /app/static-mirrors; else echo 'No static-mirrors executable found' && sleep 3600; fi"]
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: "512M"
        reservations:
          cpus: "0.5"
          memory: "256M"

  # Redis服务（用于缓存和统计）
  redis:
    image: redis:7-alpine
    container_name: static-mirrors-redis
    networks:
      - static-mirrors-network
    volumes:
      - redis-data:/data
    environment:
      - TZ=Asia/Shanghai
      - REDIS_PASSWORD=${REDIS_PASSWORD:-''}
    command:
      - "redis-server"
      - "--appendonly"
      - "yes"
      - "--requirepass"
      - "${REDIS_PASSWORD:-''}"
    restart: on-failure
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      start_period: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "256M"
        reservations:
          cpus: "0.25"
          memory: "128M"